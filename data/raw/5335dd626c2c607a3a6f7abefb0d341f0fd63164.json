{"title": "A metaanalysis of bat phylogenetics and positive selection based on genomes and transcriptomes from 18 species", "body": "Historically, the evolution of bats has been analyzed using a small number of genetic loci for many species or many genetic loci for a few species. Here we present a phylogeny of 18 bat species, each of which is represented in 1,107 orthologous gene alignments used to build the tree. We generated a transcriptome sequence of Hypsignathus monstrosus, the African hammer-headed bat, and additional transcriptome sequence for Rousettus aegyptiacus, the Egyptian fruit bat. We then combined these data with existing genomic and transcriptomic data from 16 other bat species. In the analysis of such datasets, there is no clear consensus on the most reliable computational methods for the curation of quality multiple sequence alignments since these public datasets represent multiple investigators and methods, including different source materials (chromosomal DNA or expressed RNA). Here we lay out a systematic analysis of parameters and produce an advanced pipeline for curating orthologous gene alignments from combined transcriptomic and genomic data, including a software package: the Mismatching Isoform eXon Remover (MIXR). Using this method, we created alignments of 11,677 bat genes, 1,107 of which contain orthologs from all 18 species. Using the orthologous gene alignments created, we assessed bat phylogeny and also performed a holistic analysis of positive selection acting in bat genomes. We found that 181 genes have been subject to positive natural selection. This list is dominated by genes involved in immune responses and genes involved in the production of collagens.\n\nChiroptera | phylogenetics | transcriptome | gene alignment | orthologous genes T he bat order Chiroptera is one of the most common and diversely adapted orders of organisms on Earth. Estimates of the exact number of species vary, but all estimates show bats represent a large portion of the known mammalian species, representing \u223c925 of 6,400 known species, about 15% (1, 2) . Several characteristics of bats make them inherently interesting, most uniquely their ability to fly and echolocate. Bats are also notorious for harboring viruses that transmit to humans [called zoonotic viruses (3) ]. For instance, bats are the established reservoir hosts for SARS coronavirus, Nipah virus, and Hendra virus (1, 4) . Hypsignathus monstrosus, the hammer-headed bat, has been identified as a possible reservoir host of Ebola virus (5, 6) . Marburg virus, a close relative of Ebola virus, has been isolated from Rousettus aegyptiacus (7, 8) .\n\nUnfortunately, the diversity that makes bats interesting also makes them difficult to study. Genetic information allows researchers to gain a deeper understanding of the evolutionary origins of such diverse taxa. There are several previous phylogenic analyses conducted with bats across the order Chiroptera (9) (10) (11) (12) (13) (14) (15) (16) . Given the difficulty of obtaining genetic data from a species group with such extreme diversity, there has historically been a tradeoff between number of loci analyzed and number of species analyzed (i.e., more loci can be reasonably analyzed only when a smaller number of species is considered). Some studies tackle hundreds of species at once. Most recently, Amador et al. constructed a tree containing 799 species by performing a supermatrix analysis with maximum likelihood and maximum parsimony methods using up to nine gene sequences per species (16) . Highthroughput sequencing is now lessening the burden of this tradeoff because a number of bats across the order Chiroptera have had their genomes or transcriptomes sequenced in bulk. Two studies have undertaken phylogenetic analyses of these large datasets (13, 15) .\n\nIn most evolutionary studies, the unit of analysis is the orthologous multiple sequence alignment. Ideally, one creates a Significance This work represents a large, order-wide evolutionary analysis of the order Chiroptera (bats). Our pipeline for assembling sequence data and curating orthologous multiple sequence alignments includes methods for improving results when combining genomic and transcriptomic data sources. The resulting phylogenetic tree divides the order Chiroptera into Yinpterochiroptera and Yangochiroptera, in disagreement with the previous division into Megachiroptera and Microchiroptera and in agreement with some other recent molecular studies, and also provides evidence for other contested branch placements. We also performed a genome-wide analysis of positive selection and found 181 genes with signatures of positive selection. Enrichment analysis shows these positively selected genes to be primarily related to immune responses but also, surprisingly, collagen formation. set of alignments representing each gene, each of which includes the correct ortholog from each species under analysis. However, accurately assembling short reads, identifying orthologs, and curating/vetting multiple sequence alignments from transcriptomic and genomic data are difficult tasks in an evolving field (17) . In previous studies of bats that employed highthroughput sequencing data, these bioinformatic issues were partially addressed by collecting most of the data at the same time with similar methods: whole-genome sequencing in the case of Tsagkogeorga et al. (13) or transcriptomes in the case of Lei and Dong (15) . However, the complexities of creating high-quality orthologous sequence alignments are compounded when public data from multiple sources are combined because these datasets have been collected with a variety of methods and from either chromosomal DNA or transcribed RNA. These issues may, in part, explain why the phylogenies of bats that have been created to date agree on much of the history of Chiroptera but differ in many ways as well.\n\nThe same data required to investigate phylogeny-namely, multiple sequence alignments of all available genes-is also highly valuable for guiding research into selective pressures that have influenced the genomes of bats. Of particular interest would be genes that have undergone positive natural selection in bats, possibly allowing them to better survive infection by viruses but also likely improving other processes that are specific to bat physiology, immunology, or ecology (18) (19) (20) . Positive natural selection produces in gene alignments an unusually high ratio of DNA substitutions which change the protein sequence (dN) to those that do not (dS), measured by dN/dS > 1 (21, 22) . Limited previous analysis of positive selection in bat genomes has been performed. Typically, selection has been analyzed only in key gene families for specific purposes (13, 23, 24) . These studies yielded interesting results, but we still lack a holistic view of the categories of genes most affected by selection in bat genomes.\n\nWe set out to perform a metaanalysis of available Chiropteran annotated genomes and transcriptomes, with three principal goals: a carefully curated set of orthologous gene alignments, a high-confidence phylogeny, and positive selection measurements for each gene. In the process of obtaining these goals, we developed a curation and cleaning pipeline for producing highquality orthologous multiple sequence alignments from datasets combining public data from multiple sources. We also produced transcriptomic data for R. aegyptiacus that complements previously published data (25, 26) and a transcriptomic dataset for H. monstrosus.\n\nData Collection and Assembly. The bat species analyzed in this study and the type of data associated with each are shown in Table 1 . For a few bat species, genomic (chromosomal) sequences are available, and for others, transcriptomic sequences exist. For each bat species with an annotated genome project, we downloaded the relevant RefSeq database from the National Center for Biotechnology Information (NCBI) website and extracted the protein and coding sequence of the longest isoform of each gene for orthology search. After finding orthologous genes from each species, we selected the gene isoform which most closely matched the consensus sequence for further analysis (Methods). Genome assembly accession numbers, as well as basic assembly statistics, for each genome are given in SI Appendix, Table S1 . Human, common shrew (Sorex araneus), and pig (Sus scrofa) genomes were also included as outgroups. Finally, we harvested mRNA and sequenced the transcriptomes of H. monstrosus and R. aegyptiacus on Illumina machines (Methods). For all other bats with available transcriptome data, we downloaded the raw sequencing reads from the Sequence Read Archive (SI Appendix, Table S2 ) (23, (27) (28) (29) (30) (31) (32) (33) (34) (35) (36) (37) (38) .\n\nFor the sake of consistency, we constructed transcriptome assemblies using our own pipeline, even in the cases where authors made assemblies publicly available. Briefly, our pipeline consisted of removing adapter sequences with Trimmomatic (39), followed by using two of the most popular transcriptome assemblers, the De Bruijn graph-based Trinity (40) and Trans-ABySS (41) Each species analyzed in this study, along with basic information concerning data type (genomic or transcriptomic), the number of genes here placed in orthologous gene sets, the N50 statistic (50% of bases are in contigs of length at least N50), and guanine-cytosine content (%GC) of these genes. For bats with transcriptomic data, data were all assembled and annotated as part of this study, and the number of assemblies constructed and analyzed is listed. For the other species, genomic data and annotations were all downloaded from RefSeq. Transcriptome data for two species, shown with asterisks, were generated in this study. assemblers, with a range of input parameters. This resulted in multiple tentative assemblies per bat (Table 1 and Methods) (39) (40) (41) (42) .\n\nBuilding Orthologous Gene Families. The search for orthologous genes was performed in two primary steps. First, we searched for orthologs in the genomic datasets. With genomic data, one is able to use syntenic information to help predict orthology. We used all-v-all BLAST reciprocal best hits of the protein sequences, filtered using three sources of syntenic information: public orthology predictions from BioMart, proximity via whole genome alignment, and proximity of similar neighboring genes (43) (44) (45) . Second, we searched for orthologs in transcriptomic datasets. We selected the best BLAST reciprocal best hits in transcriptomic data against genes found in the genomic orthologous gene sets, filtered by search using HMMER (46) , a hidden Markov model-based homology search software package, and filtered by match length (Methods).\n\nIn all, we were able to place 192,686 transcripts into 11,677 orthologous gene sets, of which 1,107 contain genes from all species and outgroups. Fig. 1 shows the number of transcriptomic genes found by species. Also shown is the number of genes we would have found in each species had we known a priori which assembly would perform the best for each bat and only assembled that one. With the additional work of analyzing multiple assemblies per bat, we were able to identify 9-22% more genes per bat relative to the best single assembly, representing thousands of added transcripts and improvements to the completeness of the gene network.\n\nMultiple Sequence Alignment Cleaning. Manual inspection of many multiple sequence alignments of orthologous genes revealed a nonrandom source of error: the species were biased toward segregating by data type (i.e., genomic data vs. transcriptomic data). Some poorly aligned regions would tend to agree within data type but disagree between data types. An example is shown in Fig. 2A . Furthermore, the splits were observed to happen at sharp boundaries highly suggestive of exon boundaries. This effect can be largely explained by the fact that we chose the longest isoforms predicted from annotated genome sequences, even though the longest isoforms might not be expressed at high enough levels to appear in the transcriptomic datasets from a given tissue. Other artifacts in transcriptomic or genomic data assembly and annotation could also contribute to this effect. Quantification of this bias, based on the cleaning pipeline described below, is shown in SI Appendix, Fig. S2 .\n\nTo ameliorate nonrandom assembly and isoform-selection artifacts, we developed a three-step cleaning algorithm for the multiple sequence alignments (Fig. 2B) . First, we revisited each gene derived from genomic data and replaced it, if necessary, with the isoform closest to the consensus sequence. This resulted in improvements to 3,444 transcripts, with transcripts improving their match to the consensus sequence by an average of 8%, although there was a wide range of percent improvements (Fig. 2C) .\n\nSecond, we removed exons if the species did not all agree on the exon structure. Specifically, we removed exons if all species did not agree on the aligned exon boundaries or if exon sequences differed too much in length. For phylogenetic analysis, where all genes are used in aggregate to fit a single tree, we required exact agreement in exon lengths. For gene-level positive selection analysis we required exons differ by no more than 1%. This cutoff was chosen because we observed it to be a transition point to high-gap exons in our data (SI Appendix, Fig. S1 ). Fig. 2 D-F are based on the latter threshold, and SI Appendix, Fig. S4 , shows the equivalent figures for the former.\n\nThird, we developed the Mismatching Isoform eXon Remover (MIXR) software package to detect and remove exons with alternate consensus runs directly (available at http://github.com/ hawkjo/mixr). By alternate consensus run, we mean the situation as shown in Fig. 2A , where some subset of species has a long run of amino acids which are internally consistent but which disagree from the majority of the sequences. While no substitution pattern in a single column of an alignment can distinguish real biological mutations from artifactual mismatching of isoforms, runs of an alternate consensus sequence are exponentially unlikely as a function of run length according to all site substitution models, so we want to remove them before analysis. Briefly, the MIXR algorithm works as follows. First, we define the alternateconsensus-run score, designed to give high scores to runs where some subset of species is internally consistent but differs from the majority of species. We then find the maximum alternateconsensus-run score for all species bipartitions (divisions of the species into two subsets) in a given alignment, such as the bipartition into transcriptomic and genomic species in Fig. 2A . Finally, exons with significant scores are removed. See Methods for additional details.\n\nNote that in all three of our cleaning steps, we have tried to avoid filtering on sequence divergence as much as possible. This is because our intention is to perform positive selection analysis on the cleaned alignments, an analysis which measures the ratio between nonsynonymous and synonymous mutations. Filtering strategies based on whether the protein sequences agree will directly bias the data in favor of synonymous mutations, and the exon-length-matching and MIXR steps are expected to have this effect to some degree. However, to whatever degree this is true in our data, it will have a conservative effect, biasing the data to fewer rather than more significant hits in a positive selection analysis.\n\nTo measure the efficacy of each of our filtering steps, we looked at two different measures of the filtering process. First, we looked at unanimous second-consensus runs. We define unanimous second-consensus runs to be runs in an alignment For each species where transcriptome data are being used, the number of genes placed in an orthologous gene family based on all assemblies is reported (blue), as well as the number of genes which could have been found from the best single assembly alone, had it been known a priori (gold). Which assembly was best for each species is shown as the labels for gold bars, where TrinAll indicates the Trinity assembly using all reads, and TranskXX indicates the Trans-ABySS assembly using the De Bruijn graph of kmers of length XX. Number of genes added through use of multiple assemblies over the best assembly, and percentage increase, are shown to the right of the bars. Use of multiple assemblies added 9-22% more annotated orthologs per species relative to the best single assembly. Species with raw data generated for this paper are shown in blue type.\n\nwhere some subset of species has unanimous agreement of the amino acid sequence but disagrees with the majority of species. This is correlated with but distinct from the alternate-consensus runs defined for the MIXR algorithm as it is independent of the substitution model used for the MIXR scoring function. The results after each step of the cleaning process are shown in Fig.  2D . We see that the most significant reduction in secondconsensus runs is due to the exon structure filtering step, and MIXR cleaned up essentially all of the runs which passed the previous two steps. After cleaning, only seven runs of more than three columns were detected, and those were up to only five columns in length. Furthermore, all but one of these alignments contained only species with genome data available, removing the concern of separation by data type. As a second measure of alignment improvement, we checked that the filtered sequences had increased overall sequence conservation. Our strategy, as expected, preferentially discriminates against more weakly conserved sites [as defined by CLUSTAL (47) ], filtering >80% of nonconserved sites vs. 44% for unanimous sites, and almost all gapped sites (Fig. 2E) . Furthermore, V T V P S S SA A GT L F R G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L F R G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L F R G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GG SR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GG SR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GG SR DP S V T V P S S SA A GT L F R G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GG SR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S -SC P Q L Q C C R H L V P GP L WC SDA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S Multiple sequence alignment cleaning. (A) Some multiple sequence alignments were observed to demonstrate isoform selection biased toward separation of genomic and transcriptomic data, causing nonrandom, nongapped errors segregated by the artifact of data type. (B) The alignment cleaning pipeline. First, each gene derived from genomic data was revisited to choose the isoform which best matches the consensus alignment sequence. Second, exons were filtered by structure, where exons with disagreement about boundary positions in the alignment and exons with >1% length difference between species were filtered out. Last, exons were filtered using the MIXR algorithm described in the text. (C) A total of 3,444 improved genomic isoform selections were performed, shown as a function of the improvement in percent matching the consensus sequence, i.e., (percent matching after) -(percent matching before). (D) Counts of unanimous second-consensus runs after each step of the alignment cleaning pipeline (with steps progressing from top to bottom in the graph). Unanimous second-consensus runs are defined as runs of more than three columns in a row where some minority of bat sequences agree with each other but disagree with those of all other bats. The final output contains only seven such runs with two or more species, and these are only up to three species and five amino acids long. (E) In each step of the alignment cleaning pipeline, weakly conserved sites are filtered at higher rates, enriching the final alignments for conserved sequences. \"Strong,\" \"Weak,\" and \"None\" conservation categories are as defined by Clustal (47) . Percent reduction in multiple sequence alignment column counts shown to the right. (F) Column conservation of the first 2,000 columns of the longest 2,000 alignments before and after exon filtering.\n\nboth the exon-structure filtering step and the MIXR algorithm improve sequence conservation. Fig. 2F shows the positions and distribution of conserved sites in the first 2,000 multiple sequence alignments. Many of the poor quality exons are at the ends of the alignments, which is to be expected. The ortholog finding process scores sequences based on length of agreement, which naturally tends to include matching sections in the center. The ends are then more free to vary, with variability expected due to differences in isoform selection, as well as due to incomplete or incorrect transcript assembly. Transcripts tend to have less coverage near the ends and correspondingly poorer assembly. This also helps explain why so many unanimous sites end up being filtered: correctly matched exons will still be filtered if partial assembly results in exons of different lengths. From these results, as well as manual inspection, the alignments have significantly fewer erroneous columns after exon filtering.\n\nPhylogenetic Analysis. Phylogenetic trees were constructed from these multiple sequence alignments, using multiple strategies and software packages. First, using the 1,107 genes found in all species, we constructed the species tree with a partitioned nucleotide analysis in Mr. Bayes (48) , which fits for one species tree while allowing the model parameters to vary for each gene. Next, using the same genes, we constructed the species tree with concatenated data using RAxML (49) . This we did for the full coding sequence (CDS), the amino acid sequence, and each codon position separately. We additionally fit the phylogenetic tree using RAxML with the CDS sequence of the longest 100 alignments after subjecting the corresponding amino acid alignments to manual inspection. The full length of all 100 alignments looked highly credible to manual inspection. Finally, we constructed the 1,107 gene trees with all species using Mr. Bayes and determined the species tree via coalescent analysis as implemented in AS-TRAL (50) . This was done for the full CDS sequence and each codon position separately.\n\nThe final tree is shown in Fig. 3A , with reported posterior probabilities given from the Mr. Bayes partitioned analysis. We refer to the final tree instead of a specific version of the final tree due to the strong consensus between methods. A summary of how the methods agreed or disagreed is shown in Fig. 3B . All methods converged on nearly the same species tree. In fact, due to the large amount of data, all nodes resolved with 100% reported posterior probability in both Mr. Bayes analyses. The only species not consistently placed in every analysis were Cynopterus sphinx and Murina leucogaster. Their alternative placements are shown in SI Appendix, Fig. S5 .\n\nAlso included in Fig. 3B are comparisons with previously published trees, in particular, those that included most of the species in our analysis. All species placements in our final tree agree with these trees, with the exception of two previously controversial species, Rhinolophus ferrumequinum and Miniopterus schreibersii; one particularly close node involving C. sphinx; and one surprising placement, M. leucogaster. Other order-wide phylogenetic analyses were omitted from Fig. 3B due to minimal overlap with the species considered here.\n\nThe placement of R. ferrumequinum addresses the first branching of the order Chiroptera. The traditional division of order Chiroptera into Megachiroptera and Microchiroptera, the large and small bats, respectively, has been challenged in recent years as molecular phylogenetic analyses have gained prominence. An alternative history has been proposed, dividing bats into two suborders named Yinpterochiroptera and Yangochiroptera (51) . In the proposal, the microbat families Rhinopomatidae, Rhinolophidae, Hipposideridae, and Megadermatidae are joined with the megabats to form the new clade Yinpterochiroptera, while the rest of the microbats form Yangochiroptera. Our phylogeny agrees with this model, with R. ferrumequinum falling into Yinpterochiroptera (Fig. 3A) . This restructuring has gained ad-ditional recent support (9, 11, 13, 15, 52) , although it must be noted that the accurate rooting of ancient species groups is a notoriously difficult aspect of phylogenetics (44) .\n\nThe placement of M. schreibersii has also been unclear. Agnarsson's cytochrome B-based phylogeny places M. schreibersii just outside node H on our phylogeny. On the other hand, our placement of M. schreibersii agrees with Hoofer et al. (53) , who argued that due to this placement and the large divergence, Miniopteridae deserves to be its own family, and this agrees with the other phylogenies shown in Fig. 3B as well.\n\nThe most surprising placement in our tree is that of M. leucogaster. In all of our calculated trees shown in Fig. 3B , with 100% reported posterior probability where calculated, M. leucogaster disrupts the monophyly of the genus Myotis ( Fig. 3B and  SI Appendix, Fig. S5 ). One must keep in mind, however, that the quantity of data here considered is so large it will tend to produce results with 100% reported posterior probability at each For each tree method, the rectangle at each node indicates agreement or disagreement with the consensus tree on the implied split at the node. Comparison with previously published trees is shown below. For nodes B, E, L, and P, the previously published trees agree with either our consensus phylogeny or a single alternative hypothesis: R. ferrumequinum above node G, C. sphinx above node C, M. schreibersii above node H, or M. leucogaster above node N, respectively. AA, amino acid sequence; C1-C3, the coding sequence restricted to those bases in the first, second, or third codon position, respectively; 100 manually inspected, phylogeny constructed using the longest 100 alignments after manual inspection for artifacts (none observed).\n\nnode, pushing the question of credibility further upstream to the quality of the data. No data assembly and cleaning strategy, including our own, is perfect, and it is possible that sufficient errors remain in our data as to result in an erroneous topology of such closely related species. It at first even seems suggestive, given our previous observations of bias by data type, that M. leucogaster has moved closer than expected to Myotis ricketti, the Myotis species represented by transcriptomic data. SI Appendix, Fig. S6 , takes a focused look at the data for these five bats in the 100 manually (54) (55) (56) (57) (58) . We recognize that this placement is surprising given previously published work, but our results suggest the placement of M. leucogaster may merit further consideration. One final species placement of note is Desmodus rotundus. The family Phyllostomidae (New World leaf-nosed bats) here consists of the bats within the clade defined by node H. Wetterer, et al. (59) proposed that the genus Desmodus be placed sister to the rest of the phyllostomids, which were to have formed the subfamily Phyllostominae. Our placement of Macrotus californicus, however, disrupts Phyllostominae, in agreement with the tree proposed by Rojas et al. (60) .\n\nPositive Selection Analysis. Finally, we looked within bat genomes for signatures of positive selection acting on protein-coding genes. We used the PAML software package (61) to identify dN/dS > 1 codons within each of the orthologous gene alignments that we created. We used codon models M8 and M8a, which estimate the evolutionary pressures that have acted at specific codon sites over the entire phylogeny of species included. These models do not consider unique evolutionary scenarios that have affected gene evolution along different branches over the phylogenetic tree like some other models. In M8, the data in each multiple sequence alignment is fit to a model where one group of codons from within the alignment is allowed to evolve with dN/dS > 1. M8a is the null version of this model, where that same category of codons is allowed but is constrained to dN/dS = 1. Because there is one additional degree of freedom in M8, the data will usually fit better to the M8 model (as estimated by a likelihood value). A gene was deemed to be evolving under positive selection when the data are a statistically better fit to M8 than to M8a (P < 0.05 after correction for multiple tests; Dataset S1). We performed this analysis on 10,650 genes that met criteria of having at least six species and 30 codons represented in the alignment. Out of these, 181 genes met the statistical criteria for being subject to positive natural selection, and these genes were hand-curated for function (Dataset S1). Table 2 shows a subset of the genes. Nineteen percent are known to be involved in immunity or the replication cycles of pathogens. Surprisingly, 8% are known to be involved in collagen formation, including 10 out of the 27 top scoring genes for positive selection (Dataset S1). We also looked at the gene ontology (GO) classifications which are overrepresented in the list of genes under positive selection and present this data in Dataset S2. The GO categories most enriched for positively selected genes are dominated by immune responses and collagen formation. *These genes are placed in two categories on this table. \u2020 Relatively little is known about these genes, but they are expressed solely in the testis.\n\nUnderstanding the evolutionary history of bats is important not just for the study of Chiropteran zoology but also for the study of bats as reservoirs of deadly human viruses. Knowledge of an accurate phylogeny improves analysis of positive selection in bat genomes because dN/dS analysis requires both gene alignments and a phylogenetic relationship of the orthologs being analyzed. Also, the reliable identification of gene orthologs will allow molecular biologists to functionally test differences in these genes from one species to the next (62) . Functional studies such as these will allow us to understand whether some bats have unique features of their immunity that allow them to harbor viruses that are dangerous to humans (63) . Herein, we have curated multiple sequence alignments of thousands of bat genes. Using both genomic and transcriptomic data, we were able to find 11,677 orthologous gene families. To enhance these alignments, we provided transcriptome data for two of these bats, H. monstrosus and R. aegyptiacus, from which we annotated 7,858 and 9,682 genes, respectively. We furthermore developed a general data cleaning method for filtering exons with nonrandom structural errors, in this case observed to result from genomic vs. transcriptomic data. For this method, we developed the MIXR software package which directly detects and removes alternate consensus run artifacts, and is available at http://github.com/hawkjo/mixr. The multiple sequence alignments that we have created for bat genes, both before and after exon filtering, are available for use by the wider bat and virology communities (http://numerical.recipes/chiroptera/). Using these alignments, we examined the history both of speciation and of positive selection in 18 species of bats. This study hopefully sets the stage for continued and more in-depth study of the evolution and functional differentiation of bat genes relevant to immunity and beyond. Using these orthologous gene families, we were able to reconstruct the phylogeny of the order Chiroptera using multiple methods. Due to the sheer scale of the data, we resolved each node in the tree with 100% reported posterior probability, although the topology differed slightly depending on the analysis method. Our results support the division of Chiroptera into the two suborders Yinpterochiroptera and Yangochiroptera, in disagreement with the traditional division into Megachiroptera and Microchiroptera. However, we acknowledge that rooting ancient clades continues to be a difficult phylogenetic problem, and further data may shed more light on this issue. We furthermore provide evidence for the placement of M. schreibersii, in which we agree with Hoofer and Bussche, supporting their proposal for the separation of Miniopteridae into its own family (53) . We also provide evidence for the disruption of proposed subfamily Phyllostominae by D. rotundus. Most intriguingly, we saw M. leucogaster placed in the Myotis genus, which will require further investigation.\n\nFinally, we have analyzed positive selection of genes during the speciation of bats, on a genome-wide basis. Previously, work aimed at describing adaptive evolution in bats primarily focused on their unique traits, selecting families of genes to study for selection. These studies can broadly be divided into two categories, those that dealt with specific life traits, such as echolocation or metabolism related to frugivory (24, (64) (65) (66) (67) (68) (69) (70) (71) (72) (73) , and those that were related to pathogens or immunity (74) (75) (76) (77) (78) (79) (80) . There are three studies that used larger datasets, two of which used whole-genome data (13, 23, 24) . Unlike our study, Tsagkogeorga et al. (13) used genome-wide data to ask which genes might explain the alternative subordinal topologies supported by their data. Similarly, the Shen et al. (24) study was specifically interested in energy metabolism in bats due to their energy-expensive mode of locomotion, flight. Finally, Zhang et al. (23) used whole-genome data available from two distantly related bats, along with orthologs from a number of mammals, and inferred adaptive evolution in the innate immune pathway and DNA damage checkpoint path-way. Our work, in comparison, includes more Chiropteran species and a holistic analysis of selection in the bat genome. The addition of more species, and the generation of a high-confidence tree for these species, gives us better resolution for detecting adaptive evolution specifically within Chiroptera (81) .\n\nWe find that the positively selected genes in bats are dominated by genes involved with immunity. This could have something to do with the high pathogen load that bats are thought to carry (3), but on the other hand, this finding is not unusual. Bats now join many other species groups in the finding that immune processes stand out for the strength of positive natural selection that has shaped them. The same has been found in many diverse species groups including primates (82, 83) , fish (84) , and insects (85) . It has been noted that the bats have some usual aspects of their immune systems (86) (87) (88) , which could be consistent with the evolutionary signatures of rapid sequence evolution that we observe in many genes involved in immunity.\n\nLess clear to us is why so many genes involved in collagen formation seem to be under positive selection. Collagens are a family of structural proteins that form connective tissues in the body, including tendons, ligaments, and skin (89) . The walls of veins, arteries, and capillaries also contain collagen (90) . Collectively, the different forms of collagen constitute the most abundant protein in mammalian bodies (89) . Bat wings consist of a network of collagen (91) , and bats often have injuries on their wings which need to heal quickly (92) . Recently, Pseudogymnoascus destructans, a fungal pathogen that has killed more than 6 million bats, has been reported to damage collagen (93) . It is less clear how pathogens would have placed pressure on collagen-formation pathways in the past, across many species. Alternatively, it seems possible that the demanding physical and physiological constraints inherent in muscle-powered flight put bats at an edge of what is evolutionarily achievable. In that case, one might expect to see, after speciation events, comparatively more positive selection in wing-and flightrelated genes compared with genes involved in other adaptations, with collagen an indicator of the former set.\n\nIn summary, we have provided a way to combine genomic and transcriptomic data to build reliable multiple sequence alignments. We have created multiple sequence alignments for bat genes and made them publicly available. We have used these to produce a phylogeny and to assess positive selection in bat genes. Despite this progress, bats will continue to present challenges that push the limits of genomics and phylogenetics because of their high levels of sequence divergence. Data Cleaning and Assembly. Sequencing data were first cleaned to remove sequencing adaptors and low-quality bases with Trimmomatic (39), with appropriate settings for each dataset. Trinity (40) was run with all reads, with all reads with in silico normalization, and with \u223c35 million read subsamples for those bats with large datasets as recommended in Francis et al. (95) . Trans-ABySS (41) was run with k-mer lengths of 32, 64, and all multiples of 5 from 25 to 60.\n\nFor genomic data, loci annotated as alternative loci were ignored, as well as readthrough genes. A few instances appeared with isoforms labeled as separate genes; these were manually reduced to one longest isoform.\n\nOrtholog Search. First, we found orthologs between all species using only the genomic datasets, where syntenic evidence helps confirm orthology rather than paralogy (see below). The first step was all-vs.-all BLAST-ing, filtered for e values no higher than 10 \u22125 . Reciprocal BLAST hits (for limitations, see ref. 96 ) were considered as tentative ortholog predictions (43) . Tentative predictions were further filtered by including evidence from public ortholog annotation in Biomart and, where available, syntenic evidence (see below). The resulting ortholog prediction graphs for each gene were filtered to remove any connected components with paths connecting two genes from the same species.\n\nNext, we added orthologs from the transcriptomes. First, genomic transcripts were translated to amino acid sequence, and blastx-tblastn reciprocal BLAST hits were found between all genomic high-quality orthologous genes and all transcriptome assemblies, again using an e-value cutoff of 10 \u22125 . We then created HMMER models of each of the genomic orthologous gene sets and searched within the reciprocal BLAST hit contigs for the best HMMER hit for each gene, filtering for those hits with e value below 10 \u221210 , extracting only the portion of each contig specified in the HMMER hit. We then filtered all transcripts which differed in length from the median genomic sequence length by more than 25%.\n\nSyntenic Evidence. Whole-genome alignments were performed following a procedure described on the University of California, Santa Cruz, Genome Browser wiki, which for our purposes only required aligning, chaining, and netting. Alignment was performed using Lastz (97) , while chaining and netting were performed with kentUtils (45) . Tentative orthologs are considered to have evidence of synteny if they are in syntenic regions, as defined by the top-level nodes of the net.\n\nThe algorithm used for determining gene-proximity evidence of synteny is a simple extension of the algorithm in Jarvis et al. (44) . Let species A and species B have genes a 1 and b 1 , respectively, which are tentatively orthologs. Then let a 2 be the nearest gene to a 1 on the same chromosome which has a tentative ortholog in species B, b 2 . If the number of genes between a 1 and a 2 and the number of genes between b 1 and b 2 are both less than 5, then we consider the ortholog pair a 1 -b 1 to have syntenic evidence. If there are at least five genes in each direction, but the above is not true, then there is evidence against synteny. In the case of not enough genes to either side, it is undetermined.\n\nMultiple Sequence Alignments and Best Genomic Isoforms. Multiple sequence alignments were generated on amino acid sequences with MAFFT L-INS-i, the slower but more accurate version of the popular MAFFT alignment software (98) . Manual inspection revealed that while the HMMER models had quite consistently found the same isoform from all of the transcriptomic datasets, the genomic data were slightly less consistent. This is not surprising, as different species can have different annotated longest isoforms. So, for each gene in each species with genomic data, we went back and found the isoform most similar to the consensus isoform.\n\nThe algorithm for finding best splice variant for a gene g in a given orthologous set S is as follows. First, find the consensus sequence of S from the MAFFT L-INS-i alignment. The consensus sequence is the identity in each column of the amino acid which is found in a majority of transcripts, or X if no single value is the majority. Next, align all splice variants of gene g against the consensus sequence, again using MAFFT L-INS-i, and score each by the number of nongap, non-X positions in agreement with the consensus. Select the splice variant with the highest score. This resulted in improved selection of 3,444 splice variants.\n\nFinally, we realigned for final gene alignments. Corresponding CDS alignments were created using pal2nal (99) .\n\nWe developed the MIXR software to detect and remove alternate consensus runs (available at http://github.com/hawkjo/mixr). The MIXR algorithm finds the maximum alternate-consensus-run score for each hypothesis bipartition of species and removes exons which overlap runs with significant scores-or species if removing exons would eliminate the entire alignment (see flowchart in SI Appendix, Fig. S3 ). To implement this algorithm outline, we needed to define three things: hypothesis bipartitions of species, the alternate-consensus-run scoring function, and the method used to determine significance.\n\nFirst, we define hypothesis bipartitions of species. Scoring all bipartitions is computationally intractable because for n species, there are 2 n bipartitions. We use as a heuristic the set of all bipartitions in the alignment, by which we mean subsets of species A and B for which there exists a column i in the protein alignment where the sets of amino acids in A i and B i are disjoint, i.e., no amino acid in A i is in B i and vice versa. Note that this step does not require internal agreement within A i or B i , just disjointness between them. On average, this required looking at fewer than 23 bipartitions per alignment.\n\nSecond, we define the scoring function. Let A and B be a bipartition of species such that A is the larger (or equal) subset, and let A i and B i be the corresponding sets of amino acids in the ith column. We wish to reward internal agreement within B and penalize agreement between A and B. Let M be a log-likelihood amino acid transition scoring matrix. We here use PAM30 from the NCBI toolkit, the scoring matrix used by BLAST recommended for detecting shorter sequences (100) . Then we define the score of the i th alignment column, S i , to be\n\nM\u00f0a, b\u00de if S i so calculated is positive and zero otherwise, where S 0 = 0. That is, the minimum agreement in B must be high and the maximum agreement between A and B low for several columns in a row to gain a high score. The factor of 2 in the second term reflects penalizing both agreement from A to B and B to A and is necessary to penalize complete agreement between A and B.\n\nFinally, to determine significance, we build and score negative control sequences. The negative control sequences are constructed by shuffling all columns from all alignments which contain all species to construct sequences at least 100\u00d7 as long as the longest alignment. For each alignment, we select the negative control sequences corresponding to the species in the alignment, truncate them to 100\u00d7 the length of the alignment in question, and find the maximum score for each hypothesis bipartition. Alternateconsensus-run scores larger than their corresponding negative control score thus have P values K 0.01, and are considered significant, to be removed as shown in flowchart SI Appendix, Fig. S3 . No multiple hypothesis correction is performed, conservatively removing borderline cases.\n\nPhylogenetic Analyses. Partitioned analyses in Mr. Bayes (48) used two runs with four chains, the 4 \u00d7 4 model run for 1,000,000 steps and the full codon model for 30,000 steps. Gamma models were also subsampled, resulting in a >99% reported posterior probability for the gtrsubmodel[123456] model under the 4 \u00d7 4 model and six models with >5% posterior probability for the full codon model: gtrsubmodels 123425 (24%), 123454 (17%), 123456 (17%), 123424 (16%), 123121 (10%), and 123124 (10%). RAxML (49) was run with the rapid bootstrapping and ML algorithm, the GTRGAMMA and PROTGAMMAGTR models, and with 100 different starting trees. Gene trees were created using Mr. Bayes using 100,000 steps sampled every 10 steps with 20,000 step burn-in and an inverse gamma model.\n\nPositive Selection Analysis. Positive selection analysis was performed on the 10,650 orthologous genes alignments that had at least six species and 30 amino acids represented in the alignment. For each analysis, we used the species tree generated in this study. Using PAML (61), each alignment was fit to the M8 and M8a codon models, both performed with the f61 codon model. Both the M8 and M8a models assume the dN/dS value for a given aligned codon is either a draw from a binned beta distribution (with fit parameters a and b) or a draw from a floating bin with parameter dN/dS = \u03c9. The parameter \u03c9 can float to values >1 in M8 and is set to \u03c9 = 1 for M8a. P values were calculated via \u03c7 2 test on twice the difference in reported log likelihoods of the two models, a likelihood-ratio test of nested models. GO category enrichment among positively selected genes was performed with the STRING database online software (101 "}