{"title": "Title: CryoDRGN: Reconstruction of heterogeneous structures from cryo-electron micrographs using neural networks CryoDRGN reveals dynamic continuous motions in the pre-catalytic spliceosome", "body": "leverages the representation power of deep neural networks to efficiently reconstruct highly heterogeneous complexes and continuous trajectories of protein motion. We apply this tool to two synthetic and three publicly available cryo-EM datasets, and we show that cryoDRGN provides an interpretable representation of structural heterogeneity that can be used to identify discrete states as well as continuous conformational changes. This ability enables cryoDRGN to discover previously overlooked structural states and to visualize molecules in motion.\n\n. CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint Main 1 Single particle cryo-electron microscopy (cryo-EM) is a rapidly maturing method for high-2 resolution structure determination of large macromolecular complexes 1, 2 . Major advances in 3 hardware [3] [4] [5] and software [4] [5] [6] [7] [8] [9] have streamlined the collection and analysis of cryo-EM datasets, such 4 that structures of rigid macromolecules can routinely be solved at near atomic resolution 10, 11 . 5 However, a major computational bottleneck remains when conformational or compositional 6 heterogeneity is present in the sample. 7 The crux of cryo-EM structure determination is the computational task of reconstruction, 8 where algorithms must learn the 3D density or densities from the recorded dataset of 2D particle 9 images 12 . While the standard formulation of reconstruction assumes that each 2D image is 10 generated from a single, static structure, in reality, each image contains a unique snapshot of the 11 molecule of interest. While this heterogeneity complicates reconstruction, it presents an 12 opportunity for single particle cryo-EM to reveal the conformational landscape of dynamic 13 macromolecular complexes. 14 Existing tools for heterogeneous reconstruction often make strong assumptions on the type 15 of heterogeneity in the dataset. Most commonly, heterogeneity is modeled as though it originates 16 from a small number of independent, discrete states [13] [14] [15] [16] , consistent with molecules undergoing 17 cooperative conformational changes. However, because the number of underlying structural states 18 are unknown, such discrete classification approaches are error-prone and often result in the 19 omission of potentially relevant structures. Moreover, this approach fails to model molecules that 20 undergo continuous conformational changes. In these conformationally heterogeneous systems, 21 user-defined masks have been employed to resolve isolated rigid-body motions 17 , but these 22 approaches require assumptions on the types and location of molecular motions. Additionally, new 23 . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint Determination of highly heterogeneous molecular structures 4 theoretical methods have been proposed to model global continuous heterogeneity 18-20 , however 24 no such tools have been made available. 25 Here, we present cryoDRGN (Deep Reconstructing Generative Networks), a cryo-EM 26 reconstruction method that uses a deep neural network to directly approximate the molecule's 27 continuous 3D density function (Fig. 1a) . We designed this tool based on the reasoning that deep 28 neural networks, which are known for their ability to model continuous, nonlinear functions, might 29 effectively capture dynamical structures. We show that this neural network representation of 30 structure, which we call a deep coordinate network, can efficiently learn heterogeneous ensembles 31 of high-resolution structures from single particle cryo-EM datasets 21 . 32 To learn this representation, cryoDRGN introduces an image-encoder/volume-decoder 33 framework to learn a latent representation of heterogeneity from single particle cryo-electron 34 micrographs. Once trained, users can visualize the dataset in the low-dimensional latent space, 35 which we find reflects the structural heterogeneity of the imaged molecule. This structural 36 heterogeneity can then be interrogated by generating 3D density maps at an arbitrary number of 37 desired positions within the latent space, which can be used to visualize continuous structural 38 trajectories. 39 CryoDRGN is a powerful and general approach for analyzing heterogeneity in imaging 40 datasets and can be used to reconstruct both compositionally and conformationally heterogeneous 41 structures. We demonstrate its efficacy by reconstructing and analyzing structures of the . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the representation of 3D structure from single particle cryo-EM micrographs. In contrast to traditional 50 reconstruction algorithms, which represent the 3D density map on a discretized voxel array, 51 cryoDRGN uses a neural network to predict density as a function of 3D Cartesian coordinates. We 52 call this architecture 23-25 a deep coordinate network. To model heterogeneity, the deep coordinate 53 network can be extended to predict density as a function of both 3D coordinates and continuous 54 latent variables, , which define a n-dimensional manifold of heterogeneous structures (Fig. 1a) . 55 Coordinates are featurized with a positional encoding function before they are input to the deep 56 coordinate network (Methods). This choice of model assumes that structures can be embedded 57 within a continuous low-dimensional space, i.e. the latent space, where the dimensionality of the 58 latent space is defined by the user. 59 To train this neural network representation of 3D structure from a single particle cryo-EM 60 dataset, we develop an encoder-decoder architecture based on the Variational Autoencoder 61 (VAE) 26,27 (Fig. 1b) . The structure is represented in the Fourier domain in order to relate 2D The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint Determination of highly heterogeneous molecular structures 6 regularization term on the latent space. The parameters of the neural networks are iteratively 71 updated by gradient descent on this objective function. 72 After training, the encoder network is used to map images into the low-dimensional latent 73 space, where we define \u0302= 0 ( | ) as each image's \"latent encoding\" (Fig. 1c) network produced a structure qualitatively matching the traditional reconstruction ( Fig. 2a) at 84 resolutions up to ~4.0 \u00c5 at an FSC=0.5 threshold (Fig. 2b) . 85 As neural networks have a fixed capacity for representation that is constrained by their 86 architecture, we compared architectures of different sizes to evaluate the tradeoff between 87 representation power and training speed. We found that larger architectures converged to lower 88 values of the objective function (Fig. 2c) and correlated with the traditionally reconstructed map 89 at higher resolution (Fig. 2b) . These improvements in the resulting structure came at the cost of 90 extended training times, suggesting that the architecture and the image size should be tuned to suit 91 the desired balance of training speed and achievable resolution (Supplementary Fig. 1 resulting in a series of 50 distinct but closely-related atomic models. We then generated density 99 maps along this reaction coordinate to serve as the ground truth density maps (Fig. 3a) . Cryo-EM 100 micrographs were generated by projecting the ground truth maps with random poses, followed by 101 application of the contrast transfer function (CTF) and the addition of noise (see Methods). To 102 simulate a compositionally heterogeneous dataset, this procedure was repeated by mixing images 103 generated from the bacterial 30S, 50S, and 70S ribosomal density maps (Fig. 3d) . The cryoDRGN 104 networks were then provided these simulated images and their corresponding poses, and were 105 trained with 1-dimensional (1D) latent variable models. 106 When trained on the dataset with continuous heterogeneity, we found that cryoDRGN 107 accurately modeled the full continuum of structures as assessed by two criteria. First, the latent 108 encoding of each image produced by the encoder network correlated well with the dihedral angle 109 of the underlying model (Spearman = \u22120.996), which we characterize as the ground truth 110 reaction coordinate (Fig. 3b) . Second, when provided a series of latent variable values, the deep 111 coordinate network produced structures that correlated with the ground-truth maps (Fig. 3c) . We 112 note that the deep coordinate network can generate an arbitrary number of conformations along 113 the trajectory, and found that for 100 images equally spaced along the reaction coordinate, the 114 generated structure at each image's predicted latent encoding correlated well with its ground truth 115 map (Supplementary Fig. 2) . 116 . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint Determination of highly heterogeneous molecular structures 8 When cryoDRGN was trained on the compositionally heterogeneous dataset, we observed 117 that the encoder network mapped particles to three distinct clusters in latent space (Fig. 3e) . These 118 clusters aligned with the ground truth class assignments from the 30S, 50S, and 70S ribosome 119 (classification accuracy of 99.9%), and the appropriate ribosomal structures were generated by the 120 deep coordinate network when provided with latent variable values at the corresponding cluster 121 centers (Fig. 3f, Supplementary Fig. 2) . 122 CryoDRGN uncovers residual heterogeneity in a high-resolution cryo-EM reconstruction 123 We next evaluated cryoDRGN's ability to learn heterogeneous structures from real cryo-124 EM data, which contains structured noise and imaging artifacts that are difficult to simulate. When (Fig. 4a) and observed a subset of particles separated along 132 PC1. A density map generated by the deep coordinate network from this region of latent space 133 revealed a distinct conformation of the 40S subunit, which was rotated relative to the 60S subunit 134 (Fig. 4b,c) . Concomitant with the inter-subunit rotation, we observed the disappearance of the The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint Pf40S head group, those missing the head group, and those with clearly resolved rRNA helices 140 that were absent from the homogeneous reconstruction (Fig. 4c) . 141 CryoDRGN automatically partitions assembly states of the bacterial ribosome 142 Next, we assessed cryoDRGN's ability to analyze and reconstruct density maps from a 143 dataset known to contain substantial compositional and conformational heterogeneity. For this 144 assessment, we investigated a highly heterogeneous mixture of assembly intermediates of the E. To assess the degree of heterogeneity in the data, we first trained a 1D latent variable model 157 on down-sampled images (D=128, Nyquist limit of 6.6 \u00c5) using image poses from a consensus 158 reconstruction. After model training, the encoder network was used to predict the latent encoding 159 for each particle, and the resulting histogram of the full dataset's encodings revealed five distinct 160 peaks. Four of the peaks corresponded to each of the four major classes of the LSU, and the fifth 161 peak near = \u22122 captured particles that were unassigned by Davis et al. (Fig. 5a) The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint supervision. When using the subset of particles from this region (assigned \u2264 \u22121), neither 2D 164 class averages nor a traditional 3D reconstruction produced structures consistent with assembling 165 ribosomes ( Supplementary Fig. 3 ). As we do not wish to model these impurities, we filtered the 166 dataset by the latent variable, keeping 101,604 images with > \u22121 for further analysis. 167 To explore the heterogeneity within these major assembly states, we trained a 10D latent 168 variable model on the remaining high-resolution images (D=256, Nyquist limit of 3.3 \u00c5). We 169 visualized the resulting 10D latent encodings using UMAP 33 , and observed particle super-clusters (Fig. 6a) . After sampling structures from the latent space, we observed expected spliceosome 194 conformations from the largest cluster, poorly resolved structures from the leftmost cluster, 195 structures lacking density for the SF3b domain from a third cluster, and additional density 196 consistent with particle aggregation from the uppermost cluster (Fig. 6b) . To focus our analysis 197 on bone-fide pre-catalytic spliceosome particles, we leveraged the latent space representation to 198 eliminate any particles that mapped to the undesired clusters from two replicate runs, which 199 resulted in a final particle stack of 150,098 images. 200 With the filtered particle stack, we trained a 10D model on higher resolution images 201 (D=256, Nyquist limit of 3.4 \u00c5), and visualized the dataset's latent encodings in 2D using PCA 202 and UMAP (Fig. 6a,c) . The visualized data manifold was unfeatured, consistent with a molecule The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint required for 3D classification. Finally, when analyzing the pre-catalytic spliceosome, we found 235 that the continuous conformational changes cryoDRGN reconstructed lack the rigid-body 236 boundary artifacts introduced from multibody refinement's mask-based approach 17 . 237 Interpretation of the latent space 238 A key feature of cryoDRGN is its ability to provide a low-dimensional representation of 239 the dataset's heterogeneity, which is given by each particle's latent encoding. Subject to 240 optimization, cryoDRGN organizes the latent space such that structurally related particles are in 241 close proximity. Thus, visualization of the distribution of latent encodings can be informative in 242 understanding the structural heterogeneity within the imaged ensemble. In both simulated and real 243 datasets we find that continuous motions are embedded along a continuum in latent space ( Fig.   244 3b, 6c) and that compositionally distinct states manifest as clusters (Fig. 3e, 5b) . This observation 245 suggests an interpretation of the latent encodings as an approximate conformational landscape, 246 with regions of high-particle occupancy corresponding to low-energy states, and regions of lower-247 particle occupancy denoting higher energy states. We note however that structures reconstructed 248 from unoccupied regions will not in general correspond to true physical intermediates, as 249 cryoDRGN optimizes the likelihood of the observed data and these intermediates are not observed. 250 Finally, in real datasets, there may exist images that do not originate from the standard single 251 particle image formation model, for example, false positives encountered during particle picking 9 . 252 We demonstrated the utility of the latent space encodings in identifying such impurities, ice 253 artifacts, and other such out-of-distribution particles that may be filtered out in subsequent analyses 254 (Fig. 5a, 6a) . 1,2,3,4) . 265 Practical considerations in choosing training hyperparameters 266 Although this method emphasizes an unsupervised approach to analyzing structural 267 heterogeneity, cryoDRGN does require that the user define the dimensionality of the latent space 268 and the architecture of both the encoder and decoder networks. We find that in practice, a 1D latent 269 space is effective at distinguishing bona-fide particles from contaminants and imaging artifacts 270 (Fig. 5a) , and we recommend users initially employ such a model to filter their dataset. 271 Additionally, we find that in our tested datasets, a 10D latent space provides sufficient 272 representation capacity to effectively model structural heterogeneity, and that this 10D space can 273 be readily visualized with PCA or UMAP. Notably, we recommend the use of such as 10D latent 274 space instead of lower dimensional space as we have found that 10D spaces result in much more 275 rapid overall training, which is consistent with similar observations of related overparameterized 276 neural network architectures 37,38 . Finally, users must specify the number of nodes and layers in the 277 neural networks. Here, we find an inverse relationship between neural network size and the 278 achievable resolution of a given structure (Supplemental Fig. 1) . Training larger networks on 279 larger images is significantly slower, and we recommend that users perform an initial assessment 280 using down-sampled images and relatively small networks before proceeding to high-resolution 281 reconstructions.\n\n. CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint\n\nDiscovering new states using cryoDRGN 283 CryoDRGN can be used to identify novel clusters of structurally-related particles, which 284 can then be visualized by sampling a 3D structure from that region of latent space. Indeed, in 285 analyzing the bL17-depleted LSU assembly dataset, we noted a completely new structural class, 286 which like the C-classes, lacked the central protuberance, but like the most mature E classes, 287 clearly bore a functionally critical inter-subunit helix (h68). This state was completely missed in 288 traditional hierarchical classification 32 , and provides structural evidence that this vital intersubunit 289 helix can dock in a native conformation in the absence of the central protuberance 290 (Supplementary Fig. 6) . Notably, we could validate the existence of this class by performing 291 traditional back-projection using ~1,000 particles from this cluster (Supplementary Fig. 6 ). 292 In future work, we envision using cryoDRGN to reveal the number of discrete classes, their 293 constituent particles, and to produce initial 3D models that could be used as inputs for a traditional 294 3D reconstruction. Given the mature state of such tools 39,40 , this unbiased classification approach 295 followed by traditional homogeneous reconstruction, particle polishing, and higher order image 296 aberration correction, has the potential to produce very high-resolution structures of the full 297 spectrum of discrete structural states without the need for expert-guided classification. 298 Fully unsupervised 3D reconstruction 299 As implemented, cryoDRGN uses pose estimates resulting from a traditional consensus 3D 300 reconstruction. In analyzing three publicly available datasets, we found that such consensus pose 301 estimates were sufficiently accurate to generate meaningful latent space encodings and to produce 302 interpretable density maps of distinct structures. It is clear, however, that this approach will fail if 303 the degree of structural heterogeneity in the dataset results in inaccurate pose estimates. For 304 example, a mixture of structurally unrelated complexes will align poorly to a consensus structure, 305 and thus produce poor pose estimates. Notably, our framework is differentiable with respect to 306 . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint pose variables, which, in principle, should allow for on-the-fly pose-refinement or de novo pose 307 estimation 25 , and future work will explore the efficacy of incorporating such features. The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint Analysis: After training, the dataset's latent encoding was viewed in 2D with UMAP ( Fig.   502 6a) and PCA (Fig. 6c) . Density maps in Figure 6d were generated at the latent encoding values 503 that traverse PC1 at five equally spaced points between the 5 th and 95 th percentile of PC1 values. 504 Density maps in Extended Fig. 7 were generated at the latent encoding values that traverse PC2 at 505 five equally spaced points between the 5 th and 95 th percentile of PC2 values. The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/2020.03.27.003871 doi: bioRxiv preprint"}