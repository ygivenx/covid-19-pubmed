{"title": "ZODIAC: database-independent molecular formula annotation using Gibbs sampling reveals unknown small molecules", "body": "For all ve datasets, we observe that ZODIAC outperforms SIRIUS, often substantially decreasing molecular formula annotation error rates (Fig. 1, left) . We rst consider the dendroides dataset, for which improvements are most distinctive: This dataset contains many larger compounds, and 75 % of the ground truth compounds have an m/z of 605 or higher ( Supplementary Fig. 6 ).\n\nHence, this dataset is particularly challenging for molecular formula assignment. Out of the 201 ground truth compounds, the preprocessing assigned an incorrect adduct to three; for these, the correct molecular formula is not contained in the candidate list considered by ZODIAC. For one compound, the corrected molecular formula was not ranked into the top 50. For the remaining 197 compounds, SIRIUS correctly annotated 50.76 % (100), compared to 96.95 % (191) for ZODIAC without anchors. This represents an 16.17-fold decrease in error rate. Error rates improves for compounds over the whole mass range, see Fig. 1 (right).\n\nOn the NIST1950 and tomato datasets, SIRIUS already showed excellent performance, with more than 90 % correctly annotated molecular formulas. ZODIAC further decreased error rates, from 8.51 % to 5.32 % for NIST1950 and 4.44 % to 2.22 % for tomato. The diatoms dataset is rather complex, and many compounds may contain halogens and silicon. Here, SIRIUS reaches an error rate of 12.90 %, which is reduced two-fold to 6.45 % by ZODIAC.\n\nMice stool MS/MS spectra were measured with a broader isolation window, and the dataset contains numerous chimeric and low quality spectra, most of which were discarded before running ZODIAC. Consequently, ZODIAC has a much smaller network of interdependent compounds than for the other datasets. But even spectra that were not discarded often have substantially worse quality than spectra from other datasets: For example, these spectra often contain isotope peaks of . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint Percentage of correct molecular formula annotations for dierent ZODIAC score thresholds for ve datasets. We sort compounds by ZODIAC score and calculate the rate of correct annotations for all compounds above the given thresholds. Right: Percentage of total compounds with a ZODIAC score above dierent thresholds on ve datasets.\n\nHere, we consider all compounds, with and without established ground truth. Note that scores on the x-axis are not equidistant.\n\nfragments or are undetected chimeric spectra. Our evaluation shows that even for this extremely challenging dataset, ZODIAC improves annotation results, decreasing the error rate from 30.23 % for SIRIUS to 20.93 % for ZODIAC.\n\nSome compounds in an LC-MS/MS run can result in high-scoring hits when searching in a MS/MS spectral library. ZODIAC's stochastic model allows us to integrate these hits as anchors, assuming that we can trust assigned molecular formulas to a high degree. We performed a 10-fold cross-validation to assess the improvement using anchors. We ensured structure-disjoint evaluation on the library hits, as multiple compounds in the dataset may correspond to the same structure; see ref. 8 on the importance of structure-disjoint evaluation. ZODIAC with anchors improves the error rate on the tomato dataset to 1.48 % and on mice stool to 18.60 %, but does not improve results for the other datasets.\n\nFor four datasets, ground truth molecular formulas were established by library searching only.\n\nWe tested if there is a distinct dierence between the cosine score of ZODIAC's correct and incorrect molecular formula assignments, but did not nd such a dierence ( Supplementary Fig. 8 ).\n\nWe nd that dierentiating between adducts [ ZODIAC implicitly tries to estimate the probability that an annotated molecular formula is correct; as expected from the statistical theory, we nd these estimates to be imprecise, see Fig. 2 .\n\nBut the ZODIAC score can be used to dierentiate between true and incorrect annotations: For each dataset, we sort molecular formula annotations by the ZODIAC score, and calculate the rate . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint of correct annotations for any subset of top-scoring annotations. We nd that high-scoring ZODIAC annotations are more likely to be correct, see again Fig. 2 . For this evaluation, we also considered previously discarded compounds for which SIRIUS did not rank the correct molecular formula in the top 50; for these compounds, ZODIAC cannot nd the correct molecular formula but at best, the incorrect molecular formula should receive low ZODIAC scores. Selecting a ZODIAC score threshold of 0.9 results in more than 96.5 % correct annotations while keeping 52.05 % to 88.24 % of the compounds of each dataset (Fig. 2) . In comparison, spectral library search allowed us to annotate between 3.78 % and 16.55 % of a dataset, see Supplementary Table 1. Novel molecular formulas. We now concentrate on novel molecular formulas, in the sense that these molecular formulas are not contained in the largest public molecular structure databases PubChem 17 and ChemSpider 35 . As detailed in Section Materials & Methods, we cannot rule out that the molecular formula corresponds to, say, the compound minus a water loss instead of the full compound. Clearly, the structure of any compound with a novel molecular formula is also absent from the structure databases.\n\nWe use strict lters for both the ZODIAC score, the quality of the underlying MS/MS data, and the support by other molecular formulas in the dataset. We report molecular formula annotations from all ve datasets with a) minimum ZODIAC score of 0.999, b) at least 95 % of the MS/MS spectrum intensity being explained by SIRIUS, and c) at least one molecular formula of the compound is connected to 20 or more compounds in the ZODIAC similarity network. The third criterion discards compounds where ZODIAC's results are basically identical to SIRIUS's. This results in three novel molecular formulas in the tomato dataset and 59 in the diatoms dataset, see Supplementary Table 3 and 4. Filtering less restrictively (ZODIAC score at least 0.99, at least 90 % of the MS/MS spectrum intensity being explained by SIRIUS), we annotate 31 in tomato, 103 novel molecular formulas in the diatoms dataset, one in NIST1950 and one in mice stool.\n\nIt is understood that some of these annotations may be wrong; unfortunately, a complete evaluation would require a full structural elucidation, which is experimentally infeasible. But our results clearly show that ZODIAC allows the user to select a few, potentially highly interesting compounds from a set of hundreds or thousands with low eort. Furthermore, using an example, we show in the next section that one top-scoring annotation from Supplementary Table 3 is presumably   correct. Detailed evaluation of a novel bromine-containing molecular formula. We now concentrate on one particular compound in the diatoms dataset (m/z 588.230, retention time 503.97 sec): This ZODIAC-annotated compound is protonated and has molecular formula C 24 H 47 BrNO 8 P, which is indeed absent from the structure databases. The occurrence of bromine agrees with our expectation that marine organisms can be prolic sources of organohalogens 36 . The ZODIAC score of this annotation is 1.0, the maximum value. We found multiple lines of evidence that this molecular formula annotation is correct, both in the measured isotope pattern and the three MS/MS spectra measured for m/z 588.230 (presumably the monoisotopic peak of the isotope pattern), 590.228 (presumably the M+2 peak) and 592.325 (presumably the M+4 peak), see Fig. 3 . To annotate fragments with molecular formulas, we used SIRIUS to compute a fragmentation tree for the MS/MS spectrum of the monoisotopic peak at m/z 588.230 (Fig. 3e ).\n\n1. We compared MS/MS spectra for m/z 588.230, 590.228 and 592.325 (Fig. 3a) and found them to be highly similar, conrming that these peaks are indeed isotope peaks of one compound. One peak moves between MS/MS spectra (nominal m/z 570, 572 and 574): This peak corresponds . Considering the matching NIST reference spectra, we propose that the query compound is a brominated phosphatidylcholine. Marine algae are known producers of halogenated compounds 38 .\n\nMoreover, diatoms posess the biosynthetic pathways to produce halogenated lipids 39 . Based on the fragmentation tree analysis and supported by biosynthetical considerations, we propose that the bromine atom is located on the fatty acid tail 40,41 . The putative structure and their mass fragments are shown in Fig. 3d .\n\nFinally, note that there is another novel molecular formula in the diatoms dataset annotated with high condence, namely C 24 H 49 BrNO sampler has a negligible impact. We did not evaluate our optimized Gibbs sampler against a na\u00efve version but from theoretical considerations in Section Materials & Methods, we estimate that the achieved speedup is about 25-fold.\n\nIn practice, we can speed up the construction of the similarity network, which depends quadratically on the total number of candidates: Here, we used the top 50 candidates for each compound; this conservative approach avoids the exclusion of correct molecular formulas, and also demonstrates the swiftness of our Gibbs sampling method. But running times can easily be reduced by considering fewer candidates, in particular for low mass compounds where SIRIUS usually ranks correct molecular formula much higher. Consequently, ZODIAC can be integrated into existing pipelines without substantial increase in running times.\n\nWith regards to stability and required number of epochs, we see that in the beginning both, the total network score and the number of correct molecular formula annotations, are increasing.\n\nAfter 500 to 1,000 epochs the Markov chains reach dierent local optima. Nevertheless, estimating the most likely candidates from each chain individually results in 96.95 % correct molecular formula annotation in all 10 cases. In practice, we run 10 parallel Markov chains to allow for parallelization and to make sampling more robust.\n\nWe have presented ZODIAC, a Gibbs sampling-based approach for assigning molecular formulas in biological samples analyzed by LC-MS/MS. Using ZODIAC, we observed substantial improvements of correct molecular formula annotations, in particular for large compounds; error rates decrease . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the up to 16-fold. Furthermore, the ZODIAC score allows to select the most condent annotations.\n\nDierent from many other approaches, ZODIAC is not limited to molecular formulas present in any (spectral or structural) databases. We have seen that this is not only of theoretical interest: We conrmed a novel molecular formula discovered by ZODIAC which is, as of today, not contained in PubChem or ChemSpider.\n\nWe found that adduct annotations are very important for molecular formula assignment, as it is challenging to deduce this information from isotope pattern and MS/MS data. Hence, highquality adduct annotations should be established during preprocessing. In contrast, we observed that anchors (library hits) have only a small eect on molecular formula annotations.\n\nSearching an unknown compound with novel molecular formula in a structure database will always result in an incorrect hit, and this will often go unnoticed. In contrast, a metabolite identication workow which makes use of de novo annotation methods facilitates the identication . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint of highly interesting, new metabolites. Here, ZODIAC constitutes a major step in the discovery and structural elucidation of novel metabolites, natural products, and other molecules of biological interest.\n\nCode availability. ZODIAC has been implemented in the SIRIUS software and is publicly available at https://bio.informatik.uni-jena.de/software/sirius/. The . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint\n\nThroughout this paper, the entities of interest consist of signals detected by mass spectrometry where one or more MS/MS spectra have been recorded by the instrument. It is understood that not all of these signals correspond to compounds in the biological sample; but clearly, only those signals that do correspond are of interest for our analysis. It is also understood that we usually cannot ultimately decide whether a certain signal stems from the protonated molecule [M + H] + or, say, the protonated molecule with a water loss [M\u2212H 2 O + H] + or an ammonia adduct [M + NH 3 + H] + . This is not a problem of our method but rather a general problem of mass spectrometry. For the sake of readability, we will nevertheless use the term compound instead of hypothetical compound, feature, adduct or ion. In contrast, our methods decide for each compound if it is protonated Diatoms. This dataset consists of solid phase (PPL, Agilent) extracts of the intra-and exometabolomes of a single diatom genus, a major group of marine microalgae. In total, ve culture samples of the species Pseudo-nitzschia subpacica (2\u00d7), Pseudo-nitzschia delicatissima (2\u00d7) and Pseudo-nitzschia multiseries (1\u00d7) were grown in culture from environmental isolates. Cultures included each diatom species and its associated microbiome resulting in a complex and diverse pool of metabolites. We expect the occurrence of compounds containing uncommon elements: Marine . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint microorganisms can contain halogenated organic compounds such as brominated molecules 36 ; additionally, the growth medium contained uncommon elements such as silicon and selenium. The samples were analyzed in data dependent acquisition (DDA) mode by UHPLC-MS/MS on a Q Exactive Orbitrap mass spectrometer in positive ionization mode. Metabolomics studies of marine algae are rare, and so, existing libraries are not expected to have many relevant entries, making this an interesting dataset for testing novel compound identication.\n\nMice stool. Quinn et al. used this dataset to examine the dierence between germ free and colonized mice by metabolomics 46 . In particular, some molecules were only observed in colonized mice, including novel conjugated bile acids and other food derived plant metabolites, which showed the role of the microbiome in their metabolization. Mice stool samples from a microbiome study were analyzed by UHPLC-MS/MS in data dependent acquisition mode mode on a maXis QTOF mass spectrometer in positive ionization mode. Due to technical limitations, the maXis QTOF used for mass spectrometry employs a broader isolation window of (at least 4 m/z ), and makes identication by computational methods challenging, because isotope peaks can be found in the MS/MS; it also strongly increases the chance of chimeric spectra (fragmentation spectra comprised of fragments from multiple compounds, see below).\n\nMass spectrometry data is deposited on MassIVE (https://massive.ucsd.edu/) and MassIVE accession numbers are specied. The exact set of analyzed mzML/mzXML input les is listed in Supplementary Table 7. Dendroides dataset. Sample Preparation. The latex of Euphorbia dendroides was collected and an ethyl acetate extract was prepared as described by Esposito et al. 42 . The extract was then fractionated in 17 fractions that were subjected to mass spectrometry analysis. Subsequent purication led to the isolation and structural isolation of thirteen diterpene esters characterized by extensive NMR spectroscopy and X-ray crystallography diraction analysis.\n\nMass Spectrometry Analysis. Mass spectra were acquired between m/z 150 and m/z 1,000. In the full scan mode, full width at half maximum mass resolution of the Orbitrap mass analyzer was xed at 30,000 for MS spectra and at 15,000 for MS2 spectra. Data-dependent MS n mode was used to monitor 1 to 3 most intense ions with an exclusion duration of 40 sec after 8 repetitions. The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint Mass Spectrometry Analysis. The SRM1950 samples were analyzed using an ultra-high performance liquid chromatography system (Vanquish, Thermo) coupled to an Orbitrap mass spectrometer (Q Exactive, Thermo) tted with a heated electrospray ionization (HESI-II, Thermo) probe. Chromatographic separation was accomplished using a Kinetex C18 1.3 \u00b5m, 100 \u00c5, 2.1 mm \u00d7 50 mm column tted with a C18 guard cartridge (Phenomenex) with a ow rate of 0.5 mL/min. The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint a 4 m/z isolation for 50 m/z to 8 m/z at 1,000 or higher. Lower isolation width results in a drop in sensitivity.\n\nData Availability. The mass spectrometry data were deposited on MassIVE (MSV000079949).\n\nTo ensure reproducibility, we provide a virtual machine comprising all steps of the preprocessing.\n\nThe virtual machine incorporates the OpenMS sources, executables and parameter les and all data processing scripts written in Java and Python. The workow described below is visualized in Fig. 7 Discarding features and MS/MS spectra. We excluded m/z features which eluted over a very long time during chromatography and did not produce desired mass traces in a limited time window, as such traces are considered chemical noise. To do so, we binned MS1 peaks with a bin size of 0.006 m/z. Each MS1 was normalized by the most intense peak. Each peak was counted if its relative intensity was 0.01 or higher. If a m/z bin contained peaks of more than 20 % of MS1 the m/z was considered chemical noise. Because these spurious chemical noise features have rather high mass deviation we removed all MS1 features within 30ppm.\n\nNext, we performed blank removal using blank samples from the corresponding datasets.\n\nFeatures within 15 ppm and 20 s of a blank feature were removed if intensities were lower than 2-fold of the blank feature intensity. We did not perform blank removal on the mice stool dataset, because this resulted in a low number of remaining compounds.\n\nThird, we removed features from the beginning and end of the chromatography run and features with low relative or absolute intensity; and we removed MS/MS spectra which could not be assigned to an MS1 feature, MS/MS of a precursor peak with low absolute or relative intensity, and chimeric MS/MS. See Table 2 for dataset-specic parameter values. Chimeric spectra contain fragments of multiple precursor ions; we detected chimeric spectra as follows: All peaks within the isolation window, excluding isotope peaks, were considered to contribute their intensity to the measured MS/MS. We estimated the relative intensity that the target precursor ion contributes to the MS/MS; if the target precursor ion contributed to less than 50 % of the MS/MS intensity or if a second precursor ion contributed more than 33 % of the target precursor ion intensity, the MS/MS was marked as chimeric and excluded. The Isolation window width for the Orbitrap mass spectrometer used for the dendroides, NIST1950, tomato and diatoms is 1 Da; for the mice stool dataset analyzed on a QTOF mass spectrometer an isolation window of 3 Da width and shifted by 1 Da to the right, centered at the +1 isotope peak, was assumed.\n\n. CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint Filtering MS/MS spectra. In each MS/MS spectrum, we ltered peaks using an intensity threshold of two times the median noise intensity, see Table 2 . The median noise intensity of a dataset was estimated from peaks which had no molecular formula decomposition within a 40 ppm window considering elements C, H, N, O, and P plus those elements predicted from the isotope pattern, see below. Isotope peaks were removed from MS/MS spectra of the mice stool dataset.\n\nThe SIRIUSAdapter OpenMS module combines MS/MS which are associated with the same MS1 feature. In addition, complete linkage hierarchical clustering was conducted to merge features over dierent LC-MS/MS runs. Features were merged using 15 ppm mass accuracy and a 15 sec retention time window. Features with dierent adduct annotations or features from the same run were not merged. Feature similarity was computed by the cosine product of the MS/MS (see below), and the similarity threshold for clustering was set to 0.8. When multiple features were merged into a single one, where each feature has an assigned isotope pattern, then the isotope pattern with the highest number of isotope peaks was kept. In case multiple isotope patterns had the same number of isotope peaks, the one with the most intense monoisotopic peak was kept. After merging, features were discarded if the summed MS/MS intensity was below a threshold, see Table 2 . Features with precursor mass above 850 Da are discarded: Whereas ZODIAC is clearly capable of processing such features, we found that there are no spectral library hits above this mass that can be used for evaluation, see below. Only 2.72 % of features across all datasets have m/z above 850 Da, so excluding these cannot have substantial impact on result statistics.\n\nExtending isotope patterns. OpenMS often misses low-intensity isotope peaks. To recover those peaks, we post-processed OpenMS results as follows: For each isotope pattern detected by OpenMS, we try to extend it using isotope peaks from the corresponding MS1 spectra chosen by OpenMS.\n\nIsotope pattern peaks were picked using the SIRIUS 4 isotope pattern picking subroutine. If an additional isotope peak is present in at least 66 % of the corresponding MS1, the peak was added to the isotope pattern. Subsequently, features with less than two isotope peaks are discarded.\n\nDiscarding low-quality merged MS/MS spectra. Even when considering all MS/MS spectra for some features, we sometimes have insucient information for both spectral library search and molecular formula annotation; to this end, such low-quality features were discarded. A feature is discarded if it produces less than 5 fragment peaks, estimated after merging peaks within 10 ppm or 0.0025 m/z from all corresponding MS/MS spectra; and if no fragmentation tree in the top 50 candidate list can explain at least 5 peaks accounting for at least 80 % of total spectrum intensity, see SIRIUS analysis below. Filtering low quality features decreased the number of features for dendroides from 1,078 to 784, for NIST1950 from 568 to 400, for tomato from 3,583 to 2,584, for diatoms from 3,227 to 2,075 and for mice stool from 577 to 377.\n\nFor brevity, we will refer to the features detected by OpenMS as compounds, see above. SIRIUS 4 was run with the default alphabet of elements CHNO, and at most 5 phosphorus atoms; automatic element detection from the isotope pattern 50 was enabled for sulfur, chlorine, bromine, boron, and selenium. For the diatoms dataset, we added silicon to the set of auto-detectable elements.\n\nFor the dendroides, NIST1950, and tomato datasets we used 15 ppm maximum mass deviation for SIRIUS; for diatoms and mice stool datasets we used 10 ppm. Isotope patterns were not used to lter molecular formula candidates before computing fragmentation trees.\n\nIf OpenMS provided an ionization adduct type (such as protonation, sodium adduct, potassium adduct) for a compound, only this ionization was used. We export the 50 best-scoring molecular formula candidates from SIRIUS.\n\n. CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint In cases where no ionization adduct type was provided by OpenMS, we selected one or more adducts from [M +H] + , [M +Na] + , and [M +K] + by searching for characteristic mass dierences, using the MS1 that contained the most intense peak of the precursor ion. Peaks below 5 % relative intensity were discarded for this decision. For each compound, we export the 50 best-scoring molecular formula candidates; we simultaneously ensure that for each considered ionization adduct type, at least 10 candidates are considered.\n\nWe will refer to this candidate list as the top 50.\n\nTo evaluate the performance of SIRIUS and ZODIAC, we had to annotate a subset of compounds with correct molecular formulas, to serve as our ground truth. For this, we combined manual annotation and spectral library search, as follows: For the dendroides dataset, spectral library hits were obtained for the isolated molecules that had their reference MS/MS spectra added to the GNPS library. We used molecular networking and spectral library search in analog mode 1 , along with a set of known typical biotransformation, to annotate related diterpene esters. They dier mainly by their acylation degree, and the nature of acyl residues on the diterpene backbone. This resulted in 201 compounds being annotated with molecular formulas by manual analysis of the data, see Supplementary Table 5. For the remaining datasets, we performed spectral library searches against multiple libraries, but did not add manual annotations. We searched compounds in a spectral library combining GNPS 1 , MassBank 4 , NIST17 database (National Institute of Standards and Technology, v17) and\n\nMassHunter Forensics/Toxicology PCDL library (Agilent Technologies, Inc.) 10 . We compute a similarity score assuming peaks as Gaussians, with the centroided peaks' m/z as the mean and the standard deviation being the maximum of a relative mass error of 20 ppm and an absolute mass error of 0.005 m/z. Precursor ion masses are permitted to dier by 10 ppm or 0.0025 m/z at maximum. Only library hits with a similarity score of 0.7 or higher and with at least 6 shared peaks are considered as being valid. We compute the score as the mean of the cosine score of the sample spectrum and the cosine score of the mirrored spectrum; to mirror a spectrum with precursor mass M , we replace peak m/z value m by M \u2212m. This resulted in 94 annotated compound for NIST1950, 271 for tomato, 93 for diatoms and 44 for mice stool, see Supplementary Table 6 .\n\nWe evaluate SIRIUS and ZODIAC against these ground truth molecular formulas, but we stress that beside the molecules that were isolated in Euphorbia dendroides samples and correspond to level 1 of the Metabolomics Standard Initiative ranking system, not all of these are necessarily correct. In particular, we refrain from ranking these according to the Metabolomics Standard Initiative ranking system, where level 4 corresponds to an unequivocal molecular formula. An evaluation is nevertheless meaningful because we expect only few errors on the molecular formula assignment level.\n\nIn few cases, the correct molecular formula was not ranked in the top 50 SIRIUS candidates;\n\nwe also dropped these from our evaluation, as it is not possible that ZODIAC can nd the correct molecular formula in our evaluation. We discarded four compounds for dendroides, zero for NIST1950, two for tomato, zero for diatoms and one compound for mice stool because of this criterion.\n\nSee Supplementary Table 1 for details, and see Fig. 6 for the mass distribution of the ground truth compounds. Compounds in the dendroides dataset with reference annotations have high mass, and 75 % of all reference annotations have an m/z of 605 or higher. The NIST1950 dataset resulted in library hits over a broad range of m/z values. The diatoms library hits have a median m/z of 301 but the sample itself is highly complex, as described above. Only few compounds remain in the mice stool dataset after ltering chimeric and low quality compounds, see above.\n\n. CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint\n\nWe use a probabilistic view on the molecular formula assignment problem 27 : For each hypothetical compound in the LC-MS run, we are given data such as an isotope pattern and a fragmentation pattern. This allows us to determine, for each compound c \u2208 C, a set of candidate molecular formulas that may explain the observed data. Let V be the set of all molecular formula candidates, such that V (c) \u2286 V is the subset of molecular formulas for compound c \u2208 C. It is possible that dierent compounds share an identical molecular formula explanation, but we ignore this in our presentation, solely for the sake of readability. An assignment is a mapping a : C \u2192 V where a(c) \u2208 V (c) is the molecular formula assigned to compound c. The posterior probability of an assignment a is\n\nwhere D is the observed data. We use the terms prior probability, likelihood and posterior probability according to this Bayesian point of view. Let D(c) be the observed data for compound c \u2208 C, that is, the isotope pattern and fragmentation pattern of c. We assume that the likelihoods of molecular formulas for dierent compounds are independent, and that the likelihood of any compound c only depends on its data D(c); so,\n\nNext, we dene the prior probability of an assignment as the product of priors for pairs of compounds:\n\nHere, P(u, v | true ) is the prior probability that two compounds with molecular formulas u, v cooccur in the dataset; analogously, P(u, v | false ) if u, v do not co-occur. To simplify our calculations, we introduce a mapping c : V \u2192 C that maps any molecular formula to the compound it belongs to: c(v) = c for all v \u2208 V (c), for c \u2208 C. Note that c(a(c)) = c for all c \u2208 C. Now, unfortunately, we will see that this is not easy, as the underlying computational problem is NPcomplete. Another natural question is to sample from the posterior distribution; this will be addressed below.\n\nWe now give a graph-theoretical formulation of the problem; this will allow us to establish its computational complexity, but also to come up with a more ecient algorithm. Let V , the molecular formula candidates, be the nodes of an undirected graph G = (V, E) with edge set E \u2286 V 2 . We will write uv as shorthand for a tuple {u, v} \u2208 V 2 . We use c : V \u2192 C as a node coloring with color set C. Now, an assignment is a subset A \u2286 V such that each color from C appears exactly once; in this case, A is also called multicolored. Using the notation of the previous section, we have A = a(C);\n\n. CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint recall that c(a(c)) = c for all c \u2208 C. Let w : V \u222a E \u2192 R be weights for all nodes and edges of the graph. The weight of the assignment A is\n\nThis corresponds to the node plus edge weights of a node-induced subgraph of G, for node set A \u2286 V .\n\nWe consider the following optimization problem:\n\nMaximum Multicolored Subgraph problem. We are given a graph G = (V, E), a node coloring c : V \u2192 C and weights w : V \u222a E \u2192 R. We search for an assignment A \u2286 V of maximum weight, that is, a node-induced multicolored subgraph of maximum weight.\n\nHow does this problem correspond to our probabilistic problem from the previous section? \n\nwe can show that these problems are in fact equivalent: We have log P(a | D) = w(a(C)) + \u03b1 for some constant \u03b1 \u2208 R. Here, we assumed that E = E * contains all possible edges; we call (V, E * ) a complete assignment graph. But we can encode any edge set E E * using zero edge weight for all e / \u2208 E, so both problems are equivalent. Hence, it is natural to ask for an optimal solution of the problem, which would correspond to a maximum a posteriori estimator.\n\nFor the decision version, we ask if there is an assignment with weight above some threshold \u03c4 \u2208 R. In its simplest form, all edges have weight one and all nodes have weight zero, w| E \u2261 1 and w| V \u2261 0.\n\nLemma 1. The Multicolored Subgraph problem is NP-complete, even for unit edge weights and zero node weights.\n\nProof. It is clear that the Multicolored Subgraph problem is in NP. We show that the problem is NP-hard by reduction from Clique 51 : Let G = (V, E) be an undirected, simple graph, is there a clique of size k in G? Clearly, k \u2264 n := |V |. We construct a graph H := G K k as the Cartesian graph product of G and the empty graph K k with k nodes and no edges: That is, for every node v \u2208 V we generate k copies (v, 1), . . . , (v, k) in H, and there is an edge {(u, i), (v, j)} with i = j in H if and only if there is an edge uv in G. Now, k \u2264 n implies that H contains at most n 2 nodes. We dene node colors 1, . . . , k such that c (v, i) = i for v \u2208 V and 1 \u2264 i \u2264 k. We assign zero node weights and unit edge weights for all nodes and edges in H. Now, any assignment in H corresponds to a k-node induced subgraph in G, and the weight of the assignment equals the number of edges in the node-induced subgraph; to this end, an assignment of weight k 2 would correspond to a k-clique in G.\n\nThe Multicolored Subgraph problem is a generalization of the Multicolored Clique problem; to this end, Lemma 1 can also be inferred from the complexity of Multicolored Clique, which is W[1]hard 52 . Assuming zero node and unit edge weights, the above construction implies that for any > 0, there is no polynomial time algorithm that approximates the maximum assignment weight to within a factor better than O(n 1\u2212 ), unless P = NP 53 . Furthermore, nding an assignment of weight k cannot be done in time n o(k) , unless the exponential time hypothesis fails 54,55 . Finally, we noted above that we can encode an arbitrary edge set E E * using zero edge weight for all e / \u2208 E, so:\n\n. CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint Corollary 1. The Multicolored Subgraph problem is NP-complete, even for a complete assignment graph, binary edge weights and zero node weights.\n\nFinally, we consider two problem variants: First, we may allow that some colors from C are absent from A; in this case, A is called colorful. We can encode this variant in the original problem, by adding a dummy node for each color which is connected to no other node. Second, we may assume that only edges carry weight. We can encode the Multicolored Subgraph problem in this variant, by adding a dummy color for each color and a dummy node for each node, such that if a node has a certain color, then the dummy node has the corresponding dummy color. We connect each node to its dummy node, and transfer the weight of the node to the corresponding edge. Hence, our complexity results also hold for these variants.\n\nOn the algorithmic side, it is easy to see that the Multicolored Subgraph problem can be solved by a simple Integer Linear Program (one variable per edge and one variable per color). We omit the straightforward technical details. We will not proceed in this direction, as this approach results in a single optimal solution, whereas we want to consider suboptimal solutions and marginal probabilities, which allow us to judge our individual condence when assigning molecular formulas to compounds.\n\nThe likelihood P D(c(v)) | v of a molecular formula candidate v can be computed from the posterior probability of the fragmentation tree and the isotope pattern analysis as estimated by SIRIUS 4.0 10,24 . For the Gibbs sampler, we treat these probabilities as likelihoods, although the analysis SIRIUS 4.0 also integrates certain priors 24 . To avoid proliferating running times, we usually limit further computations to the, say, 50 best-scoring molecular formulas for each compound. For each compound, we also introduce a node representing molecular formula not identied which receives likelihood from the remaining molecular formulas, and is not connected to any other nodes.\n\nFurthermore, we assume that some compounds were identied by searching in a library of tandem MS spectra, plus potentially by comparison of retention times. We refer to these compounds and the corresponding molecular formulas as anchors. Such library search results can also be wrong, so we do not exclude other molecular formula explanations, but rather give a bonus to the likelihood of the identied molecular formula. The quality of a spectral library hit can, to a certain extend, be evaluated using its score, usually the dot product (cosine score) between query and reference. Hence, the bonus may be dependent on the corresponding library search score. Given the library search score s l \u2208 [0, 1] and a minimum score to consider a library hit min l , we multiply the candidate's likelihood by \u03c8(s l , min l ) = exp \u03bb max(s l , min l ) 1 \u2212 max(s l , min l ) .\n\nCandidates which disagree with the library hit or without any library hit are scored using s l = min l .\n\nNote, that any perfect match with score of 1.0 will be chosen in any case. We remove any other candidate for this compound. We refrain from normalizing the \u03c8 to one.\n\nFor estimating priors, we will consider similarity of fragmentation patterns 32,33 : More precisely, we use similarity between fragmentation trees that were computed by SIRIUS in the previous step.\n\nFor each pair of compounds, we have to compare up to 50 times 50 fragmentation trees: For swift computations, we refrain from using fragmentation tree alignments 56 but instead, simply count the number of common fragments and precursor (root) losses in the two trees 56 . Evaluations indicate that this method, while performing worse than fragmentation tree alignments, is still able to detect structural similarity between compounds 56 . When counting common root losses, the empty root . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint loss is ignored. We introduce two modications to the score from 56 : Let n 1 , n 2 be size of the two fragmentation trees, dened by the number of fragments and root losses. Instead of normalizing the number of common fragments plus root losses s by the size of the smaller tree min{n 1 , n 2 }, we use s/n 1 + s/n 2 (6) as the normalized score; by this, we slightly penalize large trees, as having common fragments or root losses is more likely against a large than a small tree. But this score favors small trees and, hence, inferior molecular formula candidates. To this end, we use the size of the largest fragmentation tree, among all candidate molecular formulas, for the normalization of each compound; this is the maximum number of explainable peaks in the tandem MS data of the compound. Fragments and root losses can be weighted by importance \u03b9. The weight of two common fragments or root losses m 1 and m 2 is \u03b9(m 1 )\u03b9(m 2 ). The weighted size of a tree is\n\nwith fragments F and root losses R. For two molecular formulas u, v \u2208 V we denote the resulting score as s(u, v).\n\nHow can we transform this count into a prior probability? Natural choices include signicance estimates such as p-values and posterior error probabilities. We do not have a reasonable model for the score distribution of true edges; in fact, it is not know how to clearly distinguish between true and false edges in such a model. To this end, we resort to a simple prior based on p-value estimation:\n\nwhere \u03c4 \u2208 R is a thresholding parameter, and f : R \u2192 [0, 1] is a monotonically decreasing function. We introduce threshold \u03c4 because scores below a certain threshold are practically uninformative and should not be considered in our estimations. For f (x) we estimate the p-value of score x, under the null model that scores follow a certain distribution. Note that prior probabilities do in fact depend upon the (mass spectrometry) data.\n\nWe now assign node and edge weights according to (4) . Clearly, many of these edges have zero weight and can be removed from the graph. To avoid that nodes are isolated, we want to keep some edges incident to any node. This can be formulated by individual thresholds \u03c4 c \u2208 R for each color c \u2208 C and, for an edge uv, edge weight\n\nfor threshold \u03c4 uv := min{\u03c4 c(u) , \u03c4 c(v) }. This will change the weight of any assignment by an additive constant and, hence, posterior probability by a multiplicative constant.\n\nWe say that a node v is active in an assignment A if v \u2208 A, and that an edge uv is active if both u \u2208 A and v \u2208 A; then, the weight of an assignment is the sum of weights of all active nodes and edges.\n\nGibbs sampling is a Markov chain Monte Carlo algorithm for obtaining a sequence of observations approximated from a multivariate probability distribution 57 . Sampling assignments according to (2) . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint can be seen as an archetype application of a Gibbs sampler: We start with some assignment, such as the highest likelihood node (molecular formula) for each compound (color). Each epoch of the Gibbs sampler consists of |C| steps, where we iterate over all colors c \u2208 C in random order: We update the active node with color c by drawing a node with color c according to its posterior probability, conditional the current assignment of all nodes with color dierent from c. At the end of the epoch we output the current assignment, and repeat until we have reached a sucient number of samples.\n\nThis generates a Markov chain of samples converging to the posterior probability distribution of assignments. In practice, we discard samples from the beginning of the chain (burn-in period), and to avoid correlation between nearby samples, we output only every, say, 10 th sample.\n\nAssume that u \u2208 A with color c := c(u) is to be (potentially) replaced by a new node v with the same color. The probability of v \u2208 V (c), conditional all other nodes z \u2208 A with c(z) = c, can na\u00efvely be computed as\n\nComputing all conditional probabilities for drawing a node v, requires time proportional to the sum of node degrees for all nodes from V (c). That means running time for one step is of order O(|V (c)| \u00b7 |V |) and, hence, \u0398(|V | 2 ) for certain graph families.\n\nTo apply Gibbs sampling in practice, the critical point is to quickly reach a large number of samples, so that probability estimates become reliable. To further decrease running time, we assume that we have, at any step, knowledge about all (log) conditional probabilities, for all nodes v \u2208 V (c) and all colors c \u2208 C. We assume that conditional probabilities are not normalized; to sample a new active node, we uniformly draw a random number between zero and the sum of conditional probabilities, over all nodes with this color. To improve the sampling speed, we want to estimate conditional probabilities without performing a full calculation using (9). Lemma 2. One step of the Gibbs sampler, exchanging some node u by another node v with the same color c := c(u) = c(v), can be carried out in O |V (c)| + deg(u) + deg(v) time.\n\nProof. Let A \u2286 V be the current assignment with u \u2208 A. We want to choose a new node v \u2208 U from the set of candidate nodes U := V (c) for color c := c(u). We know the conditional probabilities P(v | A \u2212 {u}) for all v \u2208 U ; we sum up the conditional probabilities, then uniformly choose a random number between zero and this sum and, nally, use this random number to select one v \u2208 U . This can be carried out in time O(|U |). If u = v then we can stop at this point.\n\nSecond, we have to estimate conditional probabilities for all nodes z \u2208 V . From (9), we infer that the conditional probability only changes for those nodes z where there is a change in the neighborhood N (z) of z, and remains constant for all others. To this end, we iterate over all z \u2208 N (u), and decrease the log conditional probability of z by w(uz); then, we iterate over all z \u2208 N (v), and increase the log conditional probability of z by w(vz). Finally, for any node z \u2208 N (u) \u222a N (v), we recompute its conditional probability using the exponential function. This can be carried out in time O(deg(u) + deg(v)); afterward, all conditional probabilities are correct for the new assignment A \u2212 {u} \u222a {v}.\n\nComparing a na\u00efve graph-based implementation of a Gibbs sampler with one that uses Lemma 2, we can estimate that the speedup is of order \u0398(|V (c)|).\n\nFor the rst iteration, we use an arbitrary assignment, then compute all conditional probabilities using (9) . The method requires O(|V | + |E|) memory for storing the graph, and O(|V |) memory for storing (log) conditional probabilities. The probability of a particular molecular formula v to be correct, can now be estimated as its marginal probability: that is, the ratio of assignments in the output that contain v. The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint\n\nWe use identical parameters for all ve datasets, see (5) above: We weight fragments and root losses when comparing fragmentation trees of molecular formula candidates. Here, we use the SIRIUS 4 noise intensity scoring as importance \u03b9 in (7) . The probability that a peak p that corresponds to a fragment and root loss is not noise is \u03b9 = 1 \u2212 par(int(p)), where par is the Pareto cumulative distribution function with x min = 0.002, x median = 0.015 and int(p) \u2208 [0, 1] the relative peak intensity, see ref. 24 . To establish a threshold on the minimal similarity of fragmentation trees, we decrease score s and tree sizes n 1 and n 2 each by 1.0, see (6) .\n\nThe empirical score distributions resemble a log-normal distribution, see Supplementary Fig. 9 , so we use its Cumulative Distribution Function to estimate p-values for (8) . For the robust estimation of parameters \u00b5 and \u03c3 2 , we sampled 100,000 non-zero scores for each dataset, and used the median score as parameter \u00b5 and the median absolute deviation as parameter \u03c3 2 . We naturally expect most edges to be false edges and chose score threshold \u03c4 so that 95 % of the non-zero scores are smaller than this threshold. Finally, we use individual thresholds for each compound (color) so that at least 10 molecular formulas of this color are incident to 10 or more edges.\n\nEach molecular formula candidate of some compound receives a score s 1 , ..., s n , where s max is the largest score. We transformed SIRIUS scores to probabilities using the softmax function, where p j = exp(s j \u2212 s max ) are normalized to sum to one. To adjust for the fact that the correct molecular formula may not be in the top 50, we added a dummy node receiving the combined probability of all unconsidered candidates. Dummy nodes are not connected to any other node. SIRIUS does not report the score of all candidates, as one compound may have tens of thousands of candidates.\n\nHence, we estimated the probability of all unconsidered candidates by multiplying the number of unconsidered candidates with the lowest probability of the top 50 candidates.\n\nFinding and scoring ZODIAC anchors. ZODIAC can use (potentially incorrect) spectral library hits as anchors to improve annotations. To nd a reasonable number of anchors, we perform spectral library search in analogue mode. Resulting molecular formula annotations are not considered ground truth identications but are sucient as anchors. Only those hits were considered that have mass dierences between query and reference corresponding to a frequent biotransformation. We use the following molecular formula mass dierences as valid biotransformations We use identical parameters for all ve datasets: When scoring anchors according to (5), we use the maximum of the cosine score between the spectrum and the cosine score of the mirrored spectrum as the similarity measure, and min l = 0.5 as the score threshold parameter and \u03bb = 1, 000 as the weighting parameter. For anchors found by spectral library match in analogue mode (that is, non-identical m/z ), spectral similarity is reduced by 0.1 to account for increased uncertainty. Searching for anchors as described above resulted in 96 anchors for dendroides, 254 anchors for NIST1950, 749 for tomato, 372 for diatoms and 176 for mice stool. All spectral hits described in the previous section are anchors, too; recall that for dendroides, the ground truth was established manually and those annotations do not serve as anchors.\n\nBurn-in and number of Gibbs sampling epochs. We determined a reasonable number of Gibbs sampling iterations using the dendroides dataset. One iteration, also called epoch, is dened as one round in which each compound is updated once by choosing a new active molecular formula candidate. We run 10 independent Markov chains, see The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint correct annotations at a specic epoch increases quickly for most Markov chains until the chain seems to stay in a local optimum. We note that this number of correct molecular formula is determined at each epoch whereas ZODIAC scores are computed from the average over many epochs. From this data, we estimated a burn-in of 1,000 epochs and sampling of 2,000 iterations. Larger values increase running times but should never worsen results.\n\nIn application, we use 10 Markov chains in parallel, a burn-in of 1,000 epochs, and sample 2,000 epochs; we keep only every 10 th sample, resulting in a total of 10 \u00d7 200 = 2, 000 samples.\n\n. . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint we can only evaluate ZODIAC against a ground truth established by spectral library searching. Potentially, some ground truth molecular formula are wrong, and ZODIAC might have found the correct molecular formula which we wrongly assign as incorrect. We expect that database hits with relatively low cosine score are incorrect more often.\n\nWe have plotted the cosine score for correct and incorrect ZODIAC molecular formula assignments for NIST 1950 (a), diatoms (b), tomato (c), and mice stool (d). We do not observe a noteworthy dierence in the two distributions;\n\ninstead, correct and incorrect annotations appear to be distributed across all cosine scores. This does not mean that all library hits are correct, but that incorrect library hits are most likely to be found both for ZODIAC correct and incorrect assignments. Mirror plot of measured against simulated isotope pattern for the novel molecular formula C 24 H 47 BrNO Its intensity is one order of magnitude lower compared to the MS/MS spectrum of the M+2 peak and simulated intensities should be treated with caution.\n\n. CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint Supplementary Fig. 11 .\n\n. CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint Supplementary Table 3 : Novel molecular formulas. All molecular formulas are absent from the largest molecular structure databases PubChem 17 and ChemSpider 35 . Only molecular formula annotations with a minimum ZODIAC score of 0.999 are reported such that at least 95 % of the MS/MS spectrum intensity is being explained by the SIRIUS fragmentation tree, and at least one molecular formula of the compound is connected to 20 or more compounds.\n\nThere may be more than one hypothetical compound in an LC-MS run being annotated with one molecular formula, potentially corresponding to dierent isomers. For such cases,`# comp.' is the number of hypothetical compounds being annotated with the given molecular formula, and`max score' is the maximum ZODIAC score among these annotations. The corresponding compounds are given in Supplementary Table   dataset . CC-BY-NC-ND 4.0 International license author/funder. It is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the . https://doi.org/10.1101/842740 doi: bioRxiv preprint"}